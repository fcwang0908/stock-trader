# -*- coding: utf-8 -*-
"""stock-trader

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NbxcqmTn-0yQSsFMnI8XzfJheo3olU7y
"""

# ==========================================
# è€é™³ AI äº¤æ˜“ç³»çµ± V15.0 - åƒ¹é‡ç±Œç¢¼å…¨èƒ½ç‰ˆ
# æ–°å¢ï¼šMFI (è³‡é‡‘æµå‘æŒ‡æ¨™) + æˆäº¤é‡ç•°å‹•åµæ¸¬
# ==========================================

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots

st.set_page_config(page_title="è€é™³åƒ¹é‡åˆ†æ V15", layout="wide", page_icon="ğŸ’°")

# --- 1. æ ¸å¿ƒè¨ˆç®—å‡½æ•¸ (å« MFI èˆ‡ OBV) ---
@st.cache_data(ttl=60)
def get_data_v15(symbol):
    try:
        df = yf.download(symbol, period='6mo', interval='1d', progress=False, auto_adjust=False)
        if isinstance(df.columns, pd.MultiIndex): df.columns = df.columns.get_level_values(0)
        df = df.apply(pd.to_numeric, errors='coerce').dropna()

        # === A. åŸºç¤æŒ‡æ¨™ ===
        df['MA20'] = df['Close'].rolling(window=20).mean()
        df['MA60'] = df['Close'].rolling(window=60).mean()

        # === B. æˆäº¤é‡åˆ†æ (Volume Analysis) ===
        # è¨ˆç®—æˆäº¤é‡å¹³å‡ç·š (VMA)
        df['Vol_MA20'] = df['Volume'].rolling(window=20).mean()
        # çˆ†é‡ä¿‚æ•¸ï¼šä»Šå¤©æˆäº¤é‡æ˜¯å¹³å‡çš„å¹¾å€ï¼Ÿ
        df['Vol_Ratio'] = df['Volume'] / df['Vol_MA20']

        # === C. è³‡é‡‘æµæŒ‡æ¨™ (Money Flow Index - MFI) ===
        # MFI é¡ä¼¼ RSIï¼Œä½†å®ƒæŠŠæˆäº¤é‡ä¹Ÿç®—é€²å»ï¼Œæ¯” RSI æ›´æº–
        typical_price = (df['High'] + df['Low'] + df['Close']) / 3
        money_flow = typical_price * df['Volume']

        # åˆ¤æ–·æ­£å‘æµé‚„æ˜¯è² å‘æµ
        positive_flow = np.where(typical_price > typical_price.shift(1), money_flow, 0)
        negative_flow = np.where(typical_price < typical_price.shift(1), money_flow, 0)

        # 14å¤©åŠ ç¸½
        pos_mf_sum = pd.Series(positive_flow).rolling(window=14).sum()
        neg_mf_sum = pd.Series(negative_flow).rolling(window=14).sum()

        # è¨ˆç®— MFI
        mfi_ratio = pos_mf_sum / neg_mf_sum
        df['MFI'] = 100 - (100 / (1 + mfi_ratio))
        # è£œå›ç´¢å¼• (å› ç‚º np.where æœƒä¸Ÿå¤±ç´¢å¼•)
        df['MFI'].index = df.index

        # === D. KDJ (ä¿ç•™ä¹‹å‰çš„ Jç·šç¥å™¨) ===
        low_list = df['Low'].rolling(9, min_periods=9).min()
        high_list = df['High'].rolling(9, min_periods=9).max()
        rsv = (df['Close'] - low_list) / (high_list - low_list) * 100
        df['K'] = rsv.ewm(com=2, adjust=False).mean()
        df['D'] = df['K'].ewm(com=2, adjust=False).mean()
        df['J'] = 3 * df['K'] - 2 * df['D']

        return df.dropna()
    except Exception as e:
        return None

def analyze_volume_money(df):
    last = df.iloc[-1]
    prev = df.iloc[-2]

    score = 0
    signals = []

    # 1. è³‡é‡‘æµ (MFI) åˆ†æ
    if last['MFI'] > 80:
        score -= 2
        signals.append("ğŸ’° MFI è³‡é‡‘è¶…è²· (>80) - å¤§æˆ¶å¯èƒ½åœ¨å‡ºè²¨")
    elif last['MFI'] < 20:
        score += 2
        signals.append("ğŸ’° MFI è³‡é‡‘è¶…è³£ (<20) - åœ°æ¿åƒ¹ï¼Œæ²’äººè‚¯è³£äº†")

    # MFI èƒŒé¦³ (é«˜éšæŠ€å·§)ï¼šè‚¡åƒ¹å‰µæ–°é«˜ï¼ŒMFI å»æ²’å‰µæ–°é«˜
    if last['Close'] > prev['Close'] and last['MFI'] < prev['MFI'] and last['MFI'] > 60:
        score -= 1
        signals.append("âš ï¸ é ‚èƒŒé¦³ (åƒ¹å‡è³‡é‡‘æµå‡º) - å°å¿ƒå‡çªç ´")

    # 2. æˆäº¤é‡ (Volume) åˆ†æ
    if last['Vol_Ratio'] > 2.0: # ä»Šå¤©é‡æ˜¯å¹³å¸¸ 2å€
        if last['Close'] > last['Open']:
            score += 1
            signals.append("ğŸ”¥ çˆ†é‡é•·é™½ (Vol > 2x) - å¤§è³‡é‡‘é€²å ´")
        else:
            score -= 1
            signals.append("ğŸ’€ çˆ†é‡é•·é™° (Vol > 2x) - å¤§è³‡é‡‘ææ…Œå‡ºé€ƒ")
    elif last['Vol_Ratio'] < 0.5:
        signals.append("ğŸ’¤ ç¸®é‡ (Vol < 0.5x) - å¸‚å ´è§€æœ›")

    # 3. åƒ¹é‡é—œä¿‚ (Price-Volume Action)
    # åƒ¹å‡é‡å‡ = å¥½
    if last['Close'] > prev['Close'] and last['Volume'] > prev['Volume']:
        score += 1
        signals.append("ğŸ“ˆ åƒ¹é‡é½Šå‡ (å¥åº·ä¸Šæ¼²)")
    # åƒ¹å‡é‡è·Œ = è™›
    elif last['Close'] > prev['Close'] and last['Volume'] < prev['Volume']:
        signals.append("âš ï¸ ç¸®é‡ä¸Šæ¼² (ä¹¾å‡) - å‹•åŠ›ä¸è¶³")

    # 4. è¶¨å‹¢èˆ‡ Jç·š (è¼”åŠ©)
    if last['J'] < 10 and last['J'] > prev['J']:
        score += 1; signals.append("âš¡ Jç·šä½ä½å‹¾é ­")
    if last['Close'] > last['MA20']:
        score += 1

    return score, signals

# --- 2. ä»‹é¢ ---
st.title("ğŸ’° è€é™³ AI - åƒ¹é‡ç±Œç¢¼åˆ†æç³»çµ± (V15)")

col1, col2 = st.columns([3, 1])
with col1:
    symbol = st.text_input("è‚¡ç¥¨ä»£è™Ÿ (å¦‚ 0700.HK, NVDA)", value="^HSI").upper()
with col2:
    if st.button("æ·±åº¦åˆ†æ"): st.rerun()

df = get_data_v15(symbol)

if df is not None:
    last = df.iloc[-1]
    change = last['Close'] - df.iloc[-2]['Close']

    # é ‚éƒ¨æ•¸æ“šå¡
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("ç¾åƒ¹", f"{last['Close']:,.2f}", f"{change:+.2f}")
    c2.metric("æˆäº¤é‡ (Vol)", f"{last['Volume']/1e6:.1f}M", f"x{last['Vol_Ratio']:.1f}å€")
    c3.metric("è³‡é‡‘æµæŒ‡æ¨™ (MFI)", f"{last['MFI']:.1f}")
    c4.metric("Jç·š (è½‰å‹¢)", f"{last['J']:.1f}")

    # åˆ†æçµæœ
    score, signals = analyze_volume_money(df)

    st.markdown("---")
    st.subheader("ğŸ¤– AI åƒ¹é‡è¨ºæ–·")
    if score >= 4:
        st.success("ğŸš€ å¼·åŠ›è²·å…¥ (Strong Buy) - é‡èƒ½å……æ²› + è³‡é‡‘é€²å ´")
    elif score <= -3:
        st.error("ğŸ’¥ å¼·åŠ›è³£å‡º (Strong Sell) - çˆ†é‡ä¸‹æ®º + è³‡é‡‘å‡ºé€ƒ")
    elif score > 0:
        st.info("ğŸ‘€ åå¥½ (Weak Buy)")
    else:
        st.warning("ğŸ‘€ åæ·¡ (Weak Sell)")

    with st.expander("æŸ¥çœ‹ã€é‡ & éŒ¢ã€‘è©³ç´°è§£è®€"):
        for s in signals: st.write(s)

    # --- å°ˆæ¥­ 4 å±¤åœ–è¡¨ ---
    st.subheader("ğŸ“Š ç¶œåˆæ“ç›¤åœ–")

    # å»ºç«‹ 4 å±¤åœ–è¡¨: åƒ¹æ ¼, æˆäº¤é‡, MFIè³‡é‡‘, Jç·š
    fig = make_subplots(rows=4, cols=1, shared_xaxes=True,
                        vertical_spacing=0.03, row_heights=[0.4, 0.2, 0.2, 0.2],
                        subplot_titles=('åƒ¹æ ¼ & MA', 'æˆäº¤é‡ (Volume)', 'è³‡é‡‘æµå‘ (MFI)', 'KDJ (Jç·š)'))

    # [1] åƒ¹æ ¼ Kç·š
    fig.add_trace(go.Candlestick(x=df.index, open=df['Open'], high=df['High'],
                                 low=df['Low'], close=df['Close'], name='Price'), row=1, col=1)
    fig.add_trace(go.Scatter(x=df.index, y=df['MA20'], line=dict(color='orange', width=1), name='MA20'), row=1, col=1)

    # [2] æˆäº¤é‡ (ç´…ç¶ æŸ±)
    colors_vol = ['#00cc96' if c >= o else '#ef553b' for c, o in zip(df['Close'], df['Open'])]
    fig.add_trace(go.Bar(x=df.index, y=df['Volume'], marker_color=colors_vol, name='Volume'), row=2, col=1)
    # åŠ ä¸Š 20æ—¥å¹³å‡é‡ç·š
    fig.add_trace(go.Scatter(x=df.index, y=df['Vol_MA20'], line=dict(color='white', width=1, dash='dot'), name='Vol MA20'), row=2, col=1)

    # [3] MFI è³‡é‡‘æµ
    fig.add_trace(go.Scatter(x=df.index, y=df['MFI'], line=dict(color='#00bfff', width=2), name='MFI (è³‡é‡‘)'), row=3, col=1)
    # ç•«å‡ºè³‡é‡‘è¶…è²·è¶…è³£å€
    fig.add_hline(y=80, line_dash="dot", row=3, col=1, line_color="red")
    fig.add_hline(y=20, line_dash="dot", row=3, col=1, line_color="green")
    # å¡«è‰²é¡¯ç¤ºå€åŸŸ
    # (Plotly fill æ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡ç”¨ç°¡å–®ç·šæ¢è¡¨ç¤ºå³å¯)

    # [4] Jç·š
    fig.add_trace(go.Scatter(x=df.index, y=df['J'], line=dict(color='#ab63fa', width=2), name='Jç·š'), row=4, col=1)
    fig.add_hline(y=100, line_dash="dot", row=4, col=1, line_color="red")
    fig.add_hline(y=0, line_dash="dot", row=4, col=1, line_color="green")

    fig.update_layout(height=1000, xaxis_rangeslider_visible=False, showlegend=False, template="plotly_dark")
    st.plotly_chart(fig, use_container_width=True)

else:
    st.error("æ‰¾ä¸åˆ°æ•¸æ“šï¼Œè«‹ç¢ºèªä»£è™Ÿã€‚")